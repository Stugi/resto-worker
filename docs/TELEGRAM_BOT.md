# Telegram Bot - Онбординг

## Как работает онбординг

Бот проводит пользователя через процесс регистрации:

1. **Запуск бота** (`/start`)
   - Пользователь пишет `/start`
   - Бот создает запись в БД и просит название организации

2. **Название организации**
   - Пользователь вводит название (например, "Burger Lab")
   - Бот сохраняет временно и предлагает выбрать масштаб

3. **Выбор масштаба**
   - 1 ресторан
   - 2-5 ресторанов
   - Более 5
   - Пользователь выбирает через кнопки

4. **Получение контакта**
   - Бот просит поделиться контактом
   - После получения создается:
     - Организация
     - Биллинг (триал на 1 месяц)
     - Обновляется профиль пользователя

5. **Название первого ресторана**
   - Пользователь вводит название (например, "Флагман")
   - Бот создает ресторан в БД

6. **Магическая ссылка**
   - Бот генерирует специальную ссылку для создания группового чата
   - При клике создается Telegram-группа с ботом
   - Эта группа будет использоваться для сбора отчетов

## Установка webhook для разработки

### 1. Запусти локальный сервер
```bash
yarn dev
```

### 2. Установи ngrok
```bash
brew install ngrok  # macOS
# или скачай с https://ngrok.com
```

### 3. Запусти ngrok
```bash
ngrok http 3000
```

### 4. Установи webhook
```bash
yarn bot:set-webhook https://YOUR_NGROK_URL.ngrok.io/api/bot/webhook
```

Пример:
```bash
yarn bot:set-webhook https://a1b2-185-123-45-67.ngrok-free.app/api/bot/webhook
```

### 5. Проверь в Telegram
- Найди своего бота
- Напиши `/start`
- Пройди процесс онбординга

## Установка webhook для продакшена (Vercel)

После деплоя на Vercel:

```bash
yarn bot:set-webhook https://resto-worker.vercel.app/api/bot/webhook
```

## Удаление webhook

Если нужно удалить webhook (например, для тестирования локально без ngrok):

```bash
yarn bot:delete-webhook
```

## Переменные окружения

Убедись, что в `.env` установлен токен бота:

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
```

## Получение токена бота

1. Найди [@BotFather](https://t.me/botfather) в Telegram
2. Отправь `/newbot`
3. Следуй инструкциям
4. Скопируй токен и добавь в `.env`

## Состояния пользователя (botState)

- `WAITING_NAME` - ожидание названия организации
- `WAITING_SCALE` - ожидание выбора масштаба
- `WAITING_CONTACT` - ожидание контакта
- `WAITING_FIRST_REST` - ожидание названия первого ресторана
- `COMPLETED` - онбординг завершен

## Тестирование

После настройки webhook:
1. Напиши боту `/start`
2. Введи название: "Тестовая сеть"
3. Выбери масштаб: "1 ресторан"
4. Поделись контактом
5. Введи название ресторана: "Тестовый ресторан"
6. Получи магическую ссылку

## Troubleshooting

### Бот не отвечает
- Проверь, установлен ли webhook: `curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo`
- Проверь логи сервера
- Убедись, что ngrok запущен (для разработки)

### Ошибка "TELEGRAM_BOT_TOKEN is not set"
- Проверь `.env` файл
- Перезапусти сервер после добавления токена

### Webhook не устанавливается
- Проверь, что URL начинается с `https://`
- Убедись, что сервер доступен из интернета
- Проверь, что ngrok URL актуален (он меняется при каждом запуске)
